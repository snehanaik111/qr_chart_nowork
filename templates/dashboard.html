<!DOCTYPE html>
<html lang="en">
<head>
  <title>Dashboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/dashboard.css">
  <link rel="stylesheet" href="/static/css/responsive.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
   




</head>
<body>
  <!-- for header part -->
  <header>
    <div class="logosec" style="float: left ;">
      <div class="logo">Fuel Management System</div>
    </div>
    <div class="searchbar">
      <img src="static\imgs\logo.png" class="icn" alt="logo">
    </div>
    <div class="message">
      Welcome! <b>Name: </b> {{user.name}} 
               <b>Email: </b> {{user.email}}
    </div>
  </header>

  <div class="main-container"> 
    <div class="navcontainer">
      <nav class="nav">
        <div class="nav-upper-options">
          <div class="nav-option option1" onclick="openContent('dashboard')">
            <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210182148/Untitled-design-(29).png" class="nav-img" alt="dashboard">
            <h4>Dashboard</h4>
          </div>
         
          <div class="nav-option option6" onclick="toggleSubmenu('settingsSubmenu')">
            {% if user.is_super_admin %}
                <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210183320/4.png" class="nav-img" alt="settings">
                <h4>Settings</h4>
            {% elif user.is_admin %}
                <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210183320/4.png" class="nav-img" alt="settings">
                <h4>Settings</h4>
            {% endif %}
        </div>
        
        <div id="settingsSubmenu" class="submenu">
            {% if user.is_super_admin %}
                <div class="submenu-option" onclick="openContent('settings')">Add a Company</div>
                <div class="submenu-option" onclick="openContent('setappurl')">Application Settings</div>
            {% elif user.is_admin %}
                <div class="submenu-option" onclick="openContent('addUserAccounts')">Add a User</div>
                <div class="submenu-option" onclick="openContent('setappurl')">Application Settings</div>
            {% endif %}
        </div>
          
         
          
          <div class="nav-option logout">
            <a href="/logout" class="button2">Logout</a>
          </div>
        </div>
      </nav>
    </div>
    
    
    <div id="content" class="content-container">
      <!-- Content will be dynamically loaded here -->
    </div>
  </div>
  
  <script>
function toggleSubmenu(submenuId) {
  var submenu = document.getElementById(submenuId);
  
  if (submenu.classList.contains('show')) {
    submenu.classList.remove('show');
  } else {
    // Hide all other submenus
    var allSubmenus = document.querySelectorAll('.submenu');
    allSubmenus.forEach(function(menu) {
      menu.classList.remove('show');
    });
    
    submenu.classList.add('show');
  }
}



  
  function openContent(page) {
    // Implement your page loading logic here
    console.log('Opening page:', page);
    var content = document.getElementById('content');
    
    // For demonstration purposes, replace the content based on the page parameter
    if (page === 'addCompany') {
      content.innerHTML = '<h2>Add a Company</h2><p>Form and details for adding a company...</p>';
    } else if (page === 'applicationSettings') {
      content.innerHTML = '<h2>Application Settings</h2><p>URL used to send data to the database: <strong>https://example.com/data</strong></p>';
    } else {
      content.innerHTML = '<h2>' + page.charAt(0).toUpperCase() + page.slice(1) + '</h2><p>Content for ' + page + ' page...</p>';
    }
  }
  </script>
  
 
  
      
          
      <div class="content">
          <div id="dashboard" class="content-section active">
              
            <div class="main"> 
       <!-- Dashboard content goes here -->
        <h2>Dashboard</h2>       

    <div class="searchbar2">
      <input type="text" placeholder="Search">
      <div class="searchbtn">
        <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210180758/Untitled-design-(28).png" class="icn srchicn" alt="search-button">
      </div>
    </div>
    <div class="box-container">
      <div class="box box1">
        <div class="text">
          <h2 class="topic-heading" id="devices_logged">{{ devices_logged }}</h2>
          <h2 class="topic">Device Entries Logged</h2>
        </div>
        <img src="/static/imgs/sensor.png" alt="Views">
      </div>
      <div class="box box2">
        <div class="text">
          <h2 class="topic-heading" id="active_devices">{{ active_devices }}</h2>
          <h2 class="topic">Active Devices</h2>
        </div>
        <img src="/static/imgs/car.png" alt="likes">
      </div>
      <div class="box box3">
        <div class="text">
          <h2 class="topic-heading">320</h2>
          <h2 class="topic">Comments</h2>
        </div>
        <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210184645/Untitled-design-(32).png" alt="comments">
      </div>
      <div class="box box4">
        <div class="text">
          <h2 class="topic-heading">70</h2>
          <h2 class="topic">Published</h2>
        </div>
        <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210185029/13.png" alt="published">
      </div>
    </div>
    <script>




      
      // Function to fetch and update device entries logged count
      function updateDeviceEntriesCount() {
          $.get("/api/device_entries_logged", function(data) {
              $("#devices_logged").text(data.device_entries_logged);
          });
      }
  
      // Function to fetch and update active devices count
      function updateActiveDevicesCount() {
          $.get("/api/no_of_devices_active", function(data) {
              $("#active_devices").text(data.no_of_devices_active);
          });
      }
  
      // Function to periodically update counts
      function startAutoRefresh() {
          setInterval(function() {
              updateDeviceEntriesCount();
              updateActiveDevicesCount();
          }, 1000); // Refresh every 5 seconds
      }
  
      // Call the function to start auto-refresh when the page loads
      $(document).ready(function() {
          startAutoRefresh();
      });
  </script>
 

 

    <div class="report-container">
      <div class="report-header">
        <h1 class="recent-Articles">Recent Activity</h1>
      </div>
      <br>
  


      
      <div id="google-chart-container">


  <!--For test data simulation-->
  <button id="stop-simulation" class="styled-button1">Stop</button>

  <button id="start-simulation" class="styled-button2">Start Simulation</button>
  
  <script>
    $(document).ready(function() {
        $('#start-simulation').on('click', function() {
            $.ajax({
                url: '/start_simulation',
                method: 'POST',
                success: function(response) {
                    alert(response.message);
                },
                error: function(error) {
                    alert('Error starting simulation: ' + error.responseJSON.message);
                }
            });
        });

        $('#stop-simulation').on('click', function() {
            $.ajax({
                url: '/stop_simulation',
                method: 'POST',
                success: function(response) {
                    alert(response.message);
                },
                error: function(error) {
                    alert('Error stopping simulation: ' + error.responseJSON.message);
                }
            });
        });
    });
</script>





        <h2>Fuel Consumption Line Chart</h2>



        <br>
        <input type="date" id="startDatePicker" title="Select Start Date">
        <input type="date" id="endDatePicker" title="Select End Date">
        <button id="filterByDateRangeBtn" class="styled-button">Filter by Date Range</button>
        <input type="time" id="startTimePicker" title="Select Start Time" step="1" disabled>
        <input type="time" id="endTimePicker" title="Select End Time" step="1" disabled>
        <button id="filterByTimeRangeBtn" class="styled-button" disabled>Filter by Time Range</button>
        <button class="styled-button">
            <a href="{{ url_for('dashboard', filter='latest', page=1) }}" class="styled-link">Go to Latest</a>
        </button>
        <button id="sortByHourBtn" class="styled-button" style="display: none;">Sort by Hour</button>
        
        
        <button id="sortByMinuteBtn" class="styled-button" style="display: none;">Sort by Minute</button>
      
        <div id="currentDateTime" style="font-weight: bold; margin-top: 10px;"></div>
        
       
    
      </div>

<!-- Loading message -->
<div id="loadingMessage" class="loading-message">Loading...</div>
    <div id="plotly-chart" style="width: 100%; height: 400px;"></div>
   
    <div id="noDataMessage" class="no-data-message">No data available for the selected range.</div>
    
    <script>
       let zoomLevel = 10; // Initial zoom level
    let jsonDataParsed = null; // Store parsed JSON data

    function drawChart(data, layout) {
      $('#loadingMessage').hide(); // Hide loading message
      Plotly.newPlot('plotly-chart', data, layout);
    }

    function fetchDataAndDrawChart() {
      $('#loadingMessage').show(); // Show loading message
  
      $.ajax({
        url: "/api/sensor_data",
        dataType: "json",
        success: function(response) {
          jsonDataParsed = response;

          var data = [{
            x: jsonDataParsed.labels.slice(-zoomLevel),
            y: jsonDataParsed.volumeLiters.slice(-zoomLevel),
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Liters'
          }];

          var layout = {
            title: 'Fuel Consumption',
            xaxis: {
              title: 'Time'
            },
            yaxis: {
              title: 'Liters'
            }
          };

          drawChart(data, layout);
        },
        error: function() {
          $('#noDataMessage').show();
          $('#loadingMessage').hide(); // Hide loading message if error
        }
      });
    }

    function filterByDateRange(startDate, endDate) {
      if (!jsonDataParsed) return;

      var filteredData = {
        labels: [],
        volumeLiters: []
      };

      for (var i = 0; i < jsonDataParsed.labels.length; i++) {
        var currentDate = jsonDataParsed.labels[i].split(" ")[0].split('/').reverse().join('-');
        if (currentDate >= startDate && currentDate <= endDate) {
          filteredData.labels.push(jsonDataParsed.labels[i]);
          filteredData.volumeLiters.push(jsonDataParsed.volumeLiters[i]);
        }
      }

      if (filteredData.labels.length === 0) {
        $('#noDataMessage').show();
      } else {
        $('#noDataMessage').hide();
        var data = [{
          x: filteredData.labels,
          y: filteredData.volumeLiters,
          type: 'scatter',
          mode: 'lines+markers',
          name: 'Liters'
        }];

        var layout = {
          title: 'Fuel Consumption',
          xaxis: {
            title: 'Time'
          },
          yaxis: {
            title: 'Liters'
          }
        };

        drawChart(data, layout);

        if (startDate === endDate) {
          $('#startTimePicker').prop('disabled', false);
          $('#endTimePicker').prop('disabled', false);
          $('#filterByTimeRangeBtn').prop('disabled', false);
          $('#sortByHourBtn').show();
          $('#sortByMinuteBtn').show();
        } else {
          $('#startTimePicker').prop('disabled', true);
          $('#endTimePicker').prop('disabled', true);
          $('#filterByTimeRangeBtn').prop('disabled', true);
          $('#sortByHourBtn').hide();
          $('#sortByMinuteBtn').hide();
        }
      }
    }

    function filterByTimeRange(startDate, startTime, endDate, endTime) {
      if (!jsonDataParsed) return;

      var filteredData = {
        labels: [],
        volumeLiters: []
      };

      var startDateTimeStr = `${startDate.split('-').reverse().join('/')} ${startTime}`;
      var endDateTimeStr = `${endDate.split('-').reverse().join('/')} ${endTime}`;

      for (var i = 0; i < jsonDataParsed.labels.length; i++) {
        var dateTimeStr = jsonDataParsed.labels[i]; // Assuming format is "dd/mm/yyyy hh:mm:ss"
        if (dateTimeStr >= startDateTimeStr && dateTimeStr <= endDateTimeStr) {
          filteredData.labels.push(jsonDataParsed.labels[i]);
          filteredData.volumeLiters.push(jsonDataParsed.volumeLiters[i]);
        }
      }

      if (filteredData.labels.length === 0) {
        $('#noDataMessage').show();
      } else {
        $('#noDataMessage').hide();
        var data = [{
          x: filteredData.labels,
          y: filteredData.volumeLiters,
          type: 'scatter',
          mode: 'lines+markers',
          name: 'Liters'
        }];

        var layout = {
          title: 'Fuel Consumption',
          xaxis: {
            title: 'Time'
          },
          yaxis: {
            title: 'Liters'
          }
        };

        drawChart(data, layout);
      }
    }

    function sortByHour(date) {
      if (!jsonDataParsed) return;

      var filteredData = {
        labels: [],
        volumeLiters: []
      };

      for (var i = 0; i < jsonDataParsed.labels.length; i++) {
        var dateTimeStr = jsonDataParsed.labels[i];
        var currentDate = dateTimeStr.split(" ")[0].split('/').reverse().join('-');
        if (currentDate === date) {
          filteredData.labels.push(jsonDataParsed.labels[i]);
          filteredData.volumeLiters.push(jsonDataParsed.volumeLiters[i]);
        }
      }

      var hourlyData = {};
      for (var i = 0; i < filteredData.labels.length; i++) {
        var hour = filteredData.labels[i].split(" ")[1].split(":")[0];
        if (!hourlyData[hour]) {
          hourlyData[hour] = [];
        }
        hourlyData[hour].push(filteredData.volumeLiters[i]);
      }

      var sortedData = {
        labels: [],
        volumeLiters: []
      };

      for (var hour in hourlyData) {
        var avgVolume = hourlyData[hour].reduce((a, b) => a + b, 0) / hourlyData[hour].length;
        sortedData.labels.push(`${date.split('-').reverse().join('/')} ${hour}:00:00`);
        sortedData.volumeLiters.push(avgVolume);
      }

      if (sortedData.labels.length === 0) {
        $('#noDataMessage').show();
      } else {
        $('#noDataMessage').hide();
        var data = [{
          x: sortedData.labels,
          y: sortedData.volumeLiters,
          type: 'scatter',
          mode: 'lines+markers',
          name: 'Liters'
        }];

        var layout = {
          title: 'Fuel Consumption',
          xaxis: {
            title: 'Time'
          },
          yaxis: {
            title: 'Liters'
          }
        };

        drawChart(data, layout);
      }
    }

    function sortByMinute(date) {
      if (!jsonDataParsed) return;

      var filteredData = {
        labels: [],
        volumeLiters: []
      };

      for (var i = 0; i < jsonDataParsed.labels.length; i++) {
        var dateTimeStr = jsonDataParsed.labels[i];
        var currentDate = dateTimeStr.split(" ")[0].split('/').reverse().join('-');
        if (currentDate === date) {
          filteredData.labels.push(jsonDataParsed.labels[i]);
          filteredData.volumeLiters.push(jsonDataParsed.volumeLiters[i]);
        }
      }

      var minuteData = {};
      for (var i = 0; i < filteredData.labels.length; i++) {
        var time = filteredData.labels[i].split(" ")[1];
        var hourMinute = time.split(":").slice(0, 2).join(":");
        if (!minuteData[hourMinute]) {
          minuteData[hourMinute] = [];
        }
        minuteData[hourMinute].push(filteredData.volumeLiters[i]);
      }

      var sortedData = {
        labels: [],
        volumeLiters: []
      };

      for (var hourMinute in minuteData) {
        var avgVolume = minuteData[hourMinute].reduce((a, b) => a + b, 0) / minuteData[hourMinute].length;
        sortedData.labels.push(`${date.split('-').reverse().join('/')} ${hourMinute}:00`);
        sortedData.volumeLiters.push(avgVolume);
      }

      if (sortedData.labels.length === 0) {
        $('#noDataMessage').show();
      } else {
        $('#noDataMessage').hide();
        var data = [{
          x: sortedData.labels,
          y: sortedData.volumeLiters,
          type: 'scatter',
          mode: 'lines+markers',
          name: 'Liters'
        }];

        var layout = {
          title: 'Fuel Consumption',
          xaxis: {
            title: 'Time'
          },
          yaxis: {
            title: 'Liters'
          }
        };

        drawChart(data, layout);
      }
    }

    $(document).ready(function() {
      $('#loadingMessage').show(); // Show loading message initially
      fetchDataAndDrawChart();

      // Zoom in function
      $('#zoomInBtn').click(function() {
        if (zoomLevel > 1) {
          zoomLevel--;
          fetchDataAndDrawChart();
        }
      });

      // Zoom out function
      $('#zoomOutBtn').click(function() {
        if (jsonDataParsed && zoomLevel < jsonDataParsed.labels.length) {
          zoomLevel++;
          fetchDataAndDrawChart();
        }
      });

      // Function to update the current date and time
      function updateDateTime() {
        var now = new Date();
        var day = String(now.getDate()).padStart(2, '0');
        var month = String(now.getMonth() + 1).padStart(2, '0'); // Months are zero-based
        var year = now.getFullYear();
        var hours = String(now.getHours()).padStart(2, '0');
        var minutes = String(now.getMinutes()).padStart(2, '0');
        var seconds = String(now.getSeconds()).padStart(2, '0');
        var currentDateTime = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;

        // Update the div with the current date and time
        $('#currentDateTime').text('Current Date and Time: ' + currentDateTime);
      }

      // Update the time initially and then every second
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // Filter by date range logic
      $('#filterByDateRangeBtn').on('click', function() {
        var startDate = $('#startDatePicker').val();
        var endDate = $('#endDatePicker').val();

        if (startDate && endDate) {
          filterByDateRange(startDate, endDate);
        } else {
          alert("Please select a valid date range.");
        }
      });

      // Filter by time range logic
      $('#filterByTimeRangeBtn').on('click', function() {
        var startDate = $('#startDatePicker').val();
        var startTime = $('#startTimePicker').val();
        var endDate = $('#endDatePicker').val();
        var endTime = $('#endTimePicker').val();

        if (startTime && endTime) {
          filterByTimeRange(startDate, startTime, endDate, endTime);
        } else {
          alert("Please select a valid time range.");
        }
      });

      // Sort by hour logic
      $('#sortByHourBtn').on('click', function() {
        var startDate = $('#startDatePicker').val();
        sortByHour(startDate);
      });

      // Sort by minute logic
      $('#sortByMinuteBtn').on('click', function() {
        var startDate = $('#startDatePicker').val();
        sortByMinute(startDate);
      });

        $('#goToLatestBtn').on('click', function() {
            // Redraw with only the latest 10 entries
            var latestData = new google.visualization.DataTable();
            latestData.addColumn('string', 'Time');
            latestData.addColumn('number', 'Liters');

            for (var i = startIndex; i < jsonDataParsed.labels.length; i++) {
                latestData.addRow([jsonDataParsed.labels[i], jsonDataParsed.volumeLiters[i]]);
            }

            chart.draw(latestData, options);
        });
    } );
</script>

      
        
        
  <br>
      <br>
      <h2>Sensor Data Receiver</h2>
      <div class="table-responsive">
        <div id="seachtab">
          <form method="get" action="{{ url_for('admin_dashboard', adminname=user.name) }}">
            <input type="text" name="query" value="{{ search_query }}" placeholder="Search by ID or other fields...">
            <button type="submit">Search</button>
          </form>
        </div>
        <div id="filtertab" class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="filterDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Filter
          </button>
          <div class="dropdown-menu" aria-labelledby="filterDropdown">
            <a class="dropdown-item" href="{{ url_for('admin_dashboard', adminname=user.name, filter='latest') }}">Latest Entries</a>
            <a class="dropdown-item" href="{{ url_for('admin_dashboard', adminname=user.name, filter='oldest') }}">Oldest Entries</a>
          </div>
        </div>
        {% if filter_option == 'latest' %}
          <p class="filter-message">Displaying the latest entries</p>
        {% elif filter_option == 'oldest' %}
          <p class="filter-message">Displaying the oldest entries</p>
        {% endif %}
      
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Full Address</th>
              <th>Sensor Data</th>
              <th>Volume (Liters)</th>
              <th>Vehicle No</th>
              <th>QR Code</th>
              <th>PDF</th>
            </tr>
          </thead>
          <tbody>
            {% for data_point in sense_data %}
            <tr>
              <td>{{ data_point.id }}</td>
              <td>{{ data_point.date }}</td>
              <td>{{ data_point.full_addr }}</td>
              <td>{{ data_point.sensor_data }}</td>
              <td>{{ data_point.volume_liters }}</td>
              <td>{{ data_point.vehicleno }}</td>
              <td><img src="{{ url_for('generate_qr', id=data_point.id) }}" alt="QR Code"></td>
              <td><a href="{{ url_for('generate_pdf', id=data_point.id) }}" class="btn btn-primary">Download PDF</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      
        <!-- Pagination -->
        <div class="pagination-container">
          <div class="pagination">
            <nav aria-label="Page navigation">
              <ul class="pagination">
                {% if pagination.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('admin_dashboard', adminname=user.name, page=pagination.prev_num, filter=filter_option, query=request.args.get('query', '')) }}">Previous</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Previous</span>
                </li>
                {% endif %}
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('admin_dashboard', adminname=user.name, page=page_num, filter=filter_option, query=request.args.get('query', '')) }}">{{ page_num }}</a>
                </li>
                {% endfor %}
                {% if pagination.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('admin_dashboard', adminname=user.name, page=pagination.next_num, filter=filter_option, query=request.args.get('query', '')) }}">Next</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Next</span>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
      </div>
      
    </div>
  </div>


</div>

<script>
  const adminname = "{{ adminname }}";  // Use Flask template variable
  fetch(`/api/admin/${adminname}/dashboard`)
    .then(response => response.json())
    .then(data => {
      // Update cards and charts with the data
      updateCards(data);
      updateCharts(data);
    })
    .catch(error => console.error('Error fetching dashboard data:', error));

  function updateCards(data) {
    // Your code to update cards
  }

  function updateCharts(data) {
    // Your code to update charts
  }
</script>     




          <div id="vehicles" class="content-section">
              <h1>Vehicles Content</h1><br>
              <h4>hello </h4>
              <!-- Vehicles content goes here -->
          </div>
          <div id="fuelReport" class="content-section">
              <h1>Fuel Report Content</h1>
              <!-- Fuel Report content goes here -->
          </div>
          <div id="institution" class="content-section">
              <h1>Institution Content</h1>
              <!-- Institution content goes here -->
          </div>
          <div id="profile" class="content-section">
              <h1>profile Content</h1>
              <!-- Profile content goes here -->
  
          </div>

          <div id="setappurl" class="content-section">
            <div class="main2"> 
                <h2>Application Settings</h2>
                <!-- Profile content goes here -->
                <div class="box-container2"><br>
                    <div class="box box1">
                        <p class="text">The URL used to send data to the database is:</p>   
                    </div>
                    <h2>http://127.0.0.1:5000/api/admin/{{ user.name }}/sensor_data</h2>
                </div>
            </div>
        </div>
        

        <div id="addUserAccounts" class="content-section">
          <div class="settings-container">
              <!-- Title -->
              <div class="main1">
                  <h1 class="setts">Manage User Accounts</h1>
  
                  <!-- Card Deck for Counts -->
                  <div class="box-container1">
                      <div class="box box1">
                          <div class="text">
                              <h2 class="topic-heading" id="totalAccounts">Loading...</h2>
                              <h2 class="topic">Total Accounts</h2>
                          </div>
                          <img src="/static/imgs/sensor.png" alt="Accounts">
                      </div>
                      <div class="box box2">
                          <div class="text">
                              <h2 class="topic-heading" id="activeAccounts">Current Admin</h2>
                              <h2 class="topic">{{user.email}}</h2>
                          </div>
                          <img src="/static/imgs/car.png" alt="Active Accounts">
                      </div>
                      <div class="box box3">
                          <div class="text">
                              <h2 class="topic-heading">320</h2>
                              <h2 class="topic">Comments</h2>
                          </div>
                          <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210184645/Untitled-design-(32).png" alt="comments">
                      </div>
                      <div class="box box4">
                          <div class="text">
                              <h2 class="topic-heading">70</h2>
                              <h2 class="topic">Published</h2>
                          </div>
                          <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210185029/13.png" alt="published">
                      </div>
                  </div>
  
                  <!-- Button to toggle form visibility -->
                  <button class="btn btn-primary mb-3 float-right" type="button" data-toggle="collapse" data-target="#addUserAccountFormContainer" aria-expanded="false" aria-controls="addUserAccountFormContainer">
                      +
                  </button>
  
                  <!-- Collapsible form container -->
                  <div class="collapse" id="addUserAccountFormContainer">
                      <div class="container mt-4">
                          <h2 class="text-center mb-4">Add User Account Details</h2>
                          <form id="addUserAccountForm" action="/add_user_account" method="POST">
                              <div class="form-group">
                                  <label for="accountname">Account Name:</label>
                                  <input type="text" class="form-control" id="accountname" placeholder="Enter account name" name="accountname">
                              </div>
                              
                              <div class="form-group">
                                  <label for="accountemail">Email:</label>
                                  <input type="email" class="form-control" id="accountemail" placeholder="Enter email" name="accountemail">
                              </div>
  
                              <div class="form-group">
                                  <label for="accountpassword">Password:</label>
                                  <input type="password" class="form-control" id="accountpassword" placeholder="Enter password" name="accountpassword">
                              </div>
  
                              <div class="form-group">
                                  <label for="accountrole">Role (0-User, 1-Admin):</label>
                                  <input type="number" class="form-control" id="accountrole" placeholder="Enter Role" name="accountrole">
                              </div>
  
                              <button type="submit" class="btn btn-dark">Submit</button>
                              <a href="/login" class="btn btn-primary">Login</a>
                          </form>
                          
                          <!-- Error message placeholder -->
                          <p id="accountErrorMessage" class="text-danger mt-3" style="display: none;">Please provide credentials to register.</p>
                      </div>
                  </div> 
                  <br>
  
                  <!-- Container for the table -->
                  <div class="container table-container">
                      <br>
                      <h3 class="text-center mb-4">Current User Accounts</h3>
                      <div class="table-responsive">
                          <table id="userAccountTable" class="table table-striped table-bordered">
                              <thead>
                                  <tr>
                                      <th>Name</th>
                                      <th>Email</th>
                                      <th>Role</th>
                                      <th>Status</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  <!-- Account data will be inserted here -->
                              </tbody>
                          </table>
                      </div>
                  </div>
  
                  <!-- JavaScript functions for handling user accounts -->
                  <script>
                      function loadUserAccounts() {
                          fetch('/api/user_accounts')
                              .then(response => response.json())
                              .then(data => {
                                  const tableBody = document.querySelector('#userAccountTable tbody');
                                  tableBody.innerHTML = ''; // Clear the table body
                                  data.forEach(account => {
                                      const row = document.createElement('tr');
                                      row.innerHTML = `
                                          <td>${account.accountname}</td>
                                          <td>${account.accountemail}</td>
                                          <td>
                                              <select onchange="updateUserAccountRole(${account.id}, this.value === 'admin')">
                                                  <option value="user" ${account.is_admin ? '' : 'selected'}>User</option>
                                                  <option value="admin" ${account.is_admin ? 'selected' : ''}>Admin</option>
                                              </select>
                                          </td>
                                          <td>
                                              <label class="switch">
                                                  <input type="checkbox" ${account.status ? 'checked' : ''} 
                                                      onchange="updateUserAccountStatus(${account.id}, this.checked)">
                                                  <span class="slider round"></span>
                                              </label>
                                          </td>
                                      `;
                                      tableBody.appendChild(row);
                                  });
                              })
                              .catch(error => console.error('Error fetching user accounts:', error));
                      }
                      
                      function updateUserAccountStatus(accountId, isActive) {
                          fetch(`/api/user_accounts/${accountId}/status`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({ status: isActive }),
                          })
                          .then(response => {
                              if (!response.ok) {
                                  return response.text().then(text => {
                                      console.error('Error response from server:', text);
                                      throw new Error('Network response was not ok');
                                  });
                              }
                              return response.json();
                          })
                          .then(data => {
                              updateCounts(); // Update counts after status change
                          })
                          .catch(error => console.error('Error updating account status:', error));
                      }
                      
                      function updateUserAccountRole(accountId, isAdmin) {
                          fetch(`/api/user_accounts/${accountId}/role`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({ is_admin: isAdmin }),
                          })
                          .then(response => {
                              if (!response.ok) {
                                  return response.text().then(text => {
                                      console.error('Error response from server:', text);
                                      throw new Error('Network response was not ok');
                                  });
                              }
                              return response.json();
                          })
                          .then(data => {
                              loadUserAccounts(); // Reload user accounts list to reflect the changes
                              updateCounts(); // Update counts after role change
                          })
                          .catch(error => console.error('Error updating account role:', error));
                      }
  
                      function updateCounts() {
                          fetch('/api/account_counts')
                              .then(response => {
                                  if (!response.ok) {
                                      throw new Error('Network response was not ok');
                                  }
                                  return response.json();
                              })
                              .then(data => {
                                  document.getElementById('totalAccounts').textContent = data.totalAccounts || 'N/A';
                                  document.getElementById('activeAccounts').textContent = data.activeAccounts || 'N/A';
                              })
                              .catch(error => {
                                  console.error('Error fetching counts:', error);
                              });
                      }
                      // Function to fetch the total number of user accounts and update the UI
                      function updateTotalAccounts() {
                        fetch('/api/user_accounts')
                          .then(response => response.json())
                          .then(data => {
                            // Calculate the total number of accounts
                            const totalAccounts = data.length;

                            // Update the UI with the total number of accounts
                            document.getElementById('totalAccounts').textContent = totalAccounts;
                          })
                          .catch(error => {
                            console.error('Error fetching user accounts:', error);
                            document.getElementById('totalAccounts').textContent = 'Error';
                          });
                      }

                      // Call the function to update the total accounts when the page loads
                      document.addEventListener('DOMContentLoaded', updateTotalAccounts);
                      
                      document.getElementById('addUserAccountForm').addEventListener('submit', function(event) {
                          event.preventDefault();
                  
                          var accountname = document.getElementById('accountname').value.trim();
                          var email = document.getElementById('accountemail').value.trim();
                          var password = document.getElementById('accountpassword').value.trim();
                          var role = document.getElementById('accountrole').value.trim();
                  
                          if (accountname === '' || email === '' || password === '' || role === '') {
                              document.getElementById('accountErrorMessage').style.display = 'block';
                          } else {
                              var formData = new FormData();
                              formData.append('accountname', accountname);
                              formData.append('accountemail', email);
                              formData.append('accountpassword', password);
                              formData.append('accountrole', role);
                  
                              fetch('/add_user_account', {
                                  method: 'POST',
                                  body: formData
                              })
                              .then(response => {
                                  if (response.ok) {
                                      loadUserAccounts();
                                      updateTotalAccounts(); // Update the total accounts count
                                      updateCounts(); // Ensure counts are updated after adding a user
                                      $('#addUserAccountFormContainer').collapse('hide');
                                      document.getElementById('addUserAccountForm').reset();
                                  } else {
                                      throw new Error('Failed to submit form');
                                  }
                              })
                              .catch(error => console.error('Error:', error));
                          }
                      });
                  
                      document.addEventListener('DOMContentLoaded', function() {
                          loadUserAccounts(); // Load user account data and set toggle states based on stored data
                          updateCounts(); // Load and display initial counts
                          updateTotalAccounts();
                      });
                  </script>
              </div>
          </div>
      </div>
      



          <div id="settings" class="content-section">
            <div class="settings-container">
                <!-- Settings Title -->
                <div class="main1"> 
                <h1 class="setts">Settings</h1>
                
            
        
                <!-- Card Deck for Counts -->
               
                  <div class="box-container1">
                    <div class="box box1">
                      <div class="text">
                        <h2 class="topic-heading" id="totalClients">Loading...</h2>
                        <h2 class="topic">Total Users </h2>
                      </div>
                      <img src="/static/imgs/sensor.png" alt="Views">
                    </div>
                    <div class="box box2">
                      <div class="text">
                        <h2 class="topic-heading" id="totalCompanies">Loading...</h2>
                        <h2 class="topic">Total Companies </h2>
                      </div>
                      <img src="/static/imgs/phone.png" alt="Views">
                    </div>
                      
                    <div class="box box3">
                      <div class="text">
                        <h2 class="topic-heading">320</h2>
                        <h2 class="topic">Comments</h2>
                      </div>
                      <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210184645/Untitled-design-(32).png" alt="comments">
                    </div>
                    <div class="box box4">
                      <div class="text">
                        <h2 class="topic-heading">70</h2>
                        <h2 class="topic">Published</h2>
                      </div>
                      <img src="https://media.geeksforgeeks.org/wp-content/uploads/20221210185029/13.png" alt="published">
                    </div>
                      
                  </div>
             
              
                
                <!-- Container for the table -->
                <div class="container table-container">
                   <br>
                        <!-- Button to toggle form visibility -->
                <button class="btn btn-primary mb-3 float-right" type="button" data-toggle="collapse" data-target="#signupFormContainer" aria-expanded="false" aria-controls="signupFormContainer">
                  +
              </button>

              <!-- Collapsible form container -->
              <div class="collapse" id="signupFormContainer">
                <div class="container mt-4">
                    <h2 class="text-center mb-4">Add Company Details</h2>
                    <form id="signupForm" action="/signup" method="POST">
                        <div class="form-group">
                            <label for="name"> Company Name:</label>
                            <input type="text" class="form-control" id="name" placeholder="Enter name" name="name">
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" class="form-control" id="email" placeholder="Enter email" name="email">
                        </div>
    
                        <div class="form-group">
                            <label for="pwd">Password:</label>
                            <input type="password" class="form-control" id="pwd" placeholder="Enter password" name="password">
                        </div>
    
                        <div class="form-group">
                            <label for="is_admin">Is Admin (0-User, 1-Admin):</label>
                            <input type="number" class="form-control" id="is_admin" placeholder="Enter Role" name="is_admin">
                        </div>
    
                        <button type="submit" class="btn btn-dark">Submit</button>
                        <a href="/login" class="btn btn-primary">Login</a>
                    </form>
                    
                    <!-- Error message placeholder -->
                    <p id="errorMessage" class="text-danger mt-3" style="display: none;">Please provide credentials to register.</p>
                </div>
            </div> 
            <br>
           
         
         
            <div class="container table-container">
              <br>
              <h3 class="text-center mb-4">Current Companies</h3>
              <div class="table-responsive">
                <table id="usersTable" class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- User data will be inserted here -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <script>
              
            
          
              function loadUsers() {
                fetch('/api/users')
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.querySelector('#usersTable tbody');
                        tableBody.innerHTML = ''; // Clear the table body
                        data.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td>
                                    <select onchange="updateUserRole(${user.id}, this.value === 'admin')">
                                        <option value="user" ${user.is_admin ? '' : 'selected'}>User</option>
                                        <option value="admin" ${user.is_admin ? 'selected' : ''}>Admin</option>
                                    </select>
                                </td>
                                
                                <td>
                                    <label class="switch">
                                      <input type="checkbox" ${user.status ? 'checked' : ''} 
                                        onchange="updateUserStatus(${user.id}, this.checked)">
                                      <span class="slider round"></span>
                                    </label>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => console.error('Error fetching users:', error));
            }
            
            function updateUserStatus(userId, isActive) {
                console.log('Updating user status to:', isActive);
            
                fetch(`/api/users/${userId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: isActive }),
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error response from server:', text);
                            throw new Error('Network response was not ok');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('User status updated:', data);
                    // Optionally, show a success message or update the UI
                })
                .catch(error => console.error('Error updating user status:', error));
            }
            
            function updateUserRole(userId, isAdmin) {
              console.log('Updating user role to:', isAdmin ? 'admin' : 'user');
          
              fetch(`/api/users/${userId}/role`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ is_admin: isAdmin }),
              })
              .then(response => {
                  if (!response.ok) {
                      return response.text().then(text => {
                          console.error('Error response from server:', text);
                          throw new Error('Network response was not ok');
                      });
                  }
                  return response.json();
              })
              .then(data => {
                  console.log('User role updated:', data);
                  loadUsers(); // Optionally reload users list to reflect the changes
              })
              .catch(error => console.error('Error updating user role:', error));
          }







            // Load users on page load
            document.addEventListener('DOMContentLoaded', function() {
                loadUsers();  // Load user data and set toggle states based on stored data
            });
            
          </script>
            
            <script>
              document.getElementById('signupForm').addEventListener('submit', function(event) {
                  // Prevent the form from submitting by default
                  event.preventDefault();
                  
                  // Check if any of the input fields are empty
                  var name = document.getElementById('name').value.trim();
                  var email = document.getElementById('email').value.trim();
                  var password = document.getElementById('pwd').value.trim();
                  var is_admin = document.getElementById('is_admin').value.trim();
                  
                  if (name === '' || email === '' || password === '' || is_admin === '') {
                      // Show error message
                      document.getElementById('errorMessage').style.display = 'block';
                  } else {
                      // Create FormData object
                      var formData = new FormData();
                      formData.append('name', name);
                      formData.append('email', email);
                      formData.append('password', password);
                      formData.append('is_admin', is_admin);
                      
                      // Submit form data using fetch
                      fetch('/signup', {
                          method: 'POST',
                          body: formData
                      })
                      .then(response => {
                          if (response.ok) {
                              // Reload users and counts
                              loadUsers();
                              updateCounts();
                              // Hide form and clear fields
                              $('#signupFormContainer').collapse('hide');
                              document.getElementById('signupForm').reset();
                          } else {
                              throw new Error('Failed to submit form');
                          }
                      })
                      .catch(error => console.error('Error:', error));
                  }
              });
              
              
              // Fetch and update counts
              function updateCounts() {
                  fetch('/api/counts') // Endpoint to fetch counts data
                      .then(response => response.json())
                      .then(data => {
                          document.getElementById('totalClients').textContent = data.totalClients || 'N/A';
                          document.getElementById('totalCompanies').textContent = data.totalCompanies || 'N/A';
                      })
                      .catch(error => console.error('Error fetching counts:', error));
              }
          
              // Load users and counts on page load
              document.addEventListener('DOMContentLoaded', function() {
                  loadUsers();
                  updateCounts();
              });
          </script>
          
        </div>
        </div>
      </div>
          </div>
  <script>
    function openContent(contentId) {
      const contentSections = document.querySelectorAll('.content-section');
      contentSections.forEach(section => section.classList.remove('active'));
  
      const navOptions = document.querySelectorAll('.nav-option');
      navOptions.forEach(option => option.classList.remove('active'));
  
      const selectedContent = document.getElementById(contentId);
      if (selectedContent) {
          selectedContent.classList.add('active');
      } else {
          console.error(`No content section found with ID '${contentId}'`);
      }
  
      const selectedOption = document.querySelector(`.nav-option.option1`);
      if (selectedOption) {
          selectedOption.classList.add('active');
      } else {
          console.error(`No nav option found with class '${contentId}'`);
      }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
      openContent('dashboard');
  });
  
</script>

    
      





</body>
</html>

